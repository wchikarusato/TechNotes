
# インフォズバット Struts2でHelloWorld
Struts2でHelloWorldを表示するだけでも苦労したのでKnowledgeとして残す。
これからStruts2の勉強する人の一助になれば幸い。


# はじめに
Struts2の参考サイトは色々あるものの、サンプルが全く動かない。
原因はバージョンアップによる修正内容で大胆に方針転換したりデグレったりで、早い話し互換性が全くない為。
マイナーバージョンどころかレビジョンが違ってるだけでも動かない。

従って、常に最新(な筈)の公式サイトのチュートリアル見る事を筆者は強く勧める。

 - struts 公式
http://struts.apache.org/docs/getting-started.html

 - 公式サイトのサンプルコードも一部間違ってるので注意が必要
   struts2.5を使用している場合、web.xmlを以下に修正する必要がある
   <filter-class>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</filter-class>


# 事前準備
 -  strutsダウンロード
http://struts.apache.org/downloads.html

筆者は Struts 2.5.12 のEssential Dependencies Onlyをダウンロードした。
http://ftp.riken.jp/net/apache/struts/2.5.12/struts-2.5.12-min-lib.zip

掲題の通り、互換性がないので、なるべく呼び出すjarファイルは少ない方がいい
間違っても、AllやFullを使わないこと。
余計なjarファイルが入ってて設定ファイルとかクラス足りない言い出す。素人が手を出してはいけない。


 -  eclipseの環境設定
webの動的プロジェクト tomcat8 で作成
WEB-INF->lib以下に上記でダウンロードしたjarファイルを配置
プロジェクト右クリック->プロパティ->Javaのビルドパス->JARの追加で追加したjarファイルを選択

あとはサンプルの通り

-- web.xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/javaee" xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd" id="WebApp_ID" version="2.5">
  <display-name>helloworld</display-name>
  <filter>
    <filter-name>struts2</filter-name>
    <filter-class>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</filter-class>
  </filter>

  <filter-mapping>
    <filter-name>struts2</filter-name>
     <url-pattern>/*</url-pattern>
  </filter-mapping>
</web-app>

-- index.jsp
  <%@ page language="java" contentType="text/html; charset=UTF-8" 
     pageEncoding="UTF-8"%>
  <%@ taglib prefix="s" uri="/struts-tags" %> <!-- struts2のタグを使える様にするおまじない -->
  <html>
  <body>
    <s:form>
      こんにちは。
      <s:submit method="hello" value="こちらこそこんにちは"/>
<!-- s:submitタグで実行するActionクラスのメソッド名をmethod属性で定義する -->
    </s:form>
  </body>
  </html>


-- indexAction.java
  import com.opensymphony.xwork2.ActionSupport;

  public class indexAction extends ActionSupport {
//<-ActionSupportクラスを継承する事でリクエストパラメータやセッションの取得、バリデーションチェックなどを行う
    public String execute() throws Exception {
      return "success";
    }
    public String message;

    public String hello() throws Exception {
      message = “いえいえこちらこそこんにちは。”;
      return "hello";
    }
  }

-- index-hello.jsp
  <%@ page language="java" contentType="text/html; charset=UTF-8" 
    pageEncoding="UTF-8"%>
  <%@ taglib prefix="s" uri="/struts-tags" %>
  <html>
  <body>
    <s:property value=”%{message}”/>
  </body>
  </html>

-- WebContent/WEB-INF/web.xml
filter-mappingでurlが/*の場合、struts2フィルターを通す様に設定している
  <filter>
    <filter-name>struts2</filter-name>
    <filter-class>org.apache.struts2.dispatcher.FilterDispatcher
    </filter-class>
    <init-param>
      <param-name>actionPackages</param-name>
      <param-value>test</param-value>
    </init-param>
  </filter>

  <filter-mapping>
    <filter-name>struts2</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>



- リファレンス
apacheのsタグリファレンス(サンプルコードはあるけど動作結果が書いてないから非常にわかりにくい
https://struts.apache.org/docs/tag-reference.html



-  sタグ
s:action : Action実行、結果viewを読み込む
s:bean : インスタンス生成
s:param : パラメータ提供
s:date : 日付出力、指定日付との差出力
s:push : Value Stackに値を入れる
s:set : application,session,requst,page,action（request）の指定範囲で値を設定
s:url : URL生成
s:include : JSP読み込み
s:i18n : 国際化リソース指定
s:text : 国際化出力
s:debug : OGNLのStack Context, Value Stackのデバック情報表示
s:property : 属性出力

sjタグ
struts2-jqueryプラグインを使ってjquery属性を呼び出している模様
sj:select selectを作成する??


-  xmlあれこれ
result name="redirect" type="redirectAction"


=  以下、参考
http://eichisanden.hateblo.jp/entry/2012/02/26/000305

https://eng-entrance.com/java-servlet-tomcat-install

struts ダウンロード
http://archive.apache.org/dist/struts/binaries/

struts-2.2.3-all.zip
->解凍すると \struts-2.2.3\apps の中にstruts2-xxx.warファイルがある
->tomcatのwebapps/配下にコピーし、http://localhost:8080/struts2-xxx/にアクセス

動かすのに必要なのはjspとActionクラスファイルの2つ
Actionクラスにviewとmodelの橋渡しコードを書いていく
入力フォームの値を取得したり、DBへの操作を行ったりするのがActionクラス

例.indexページ
http://localhost:8080/sample/index.action
に接続する
こんにちは の下にボタンが表示され、ボタンを押すと こちらこそ と返す

処理は以下の順になる
初期表示
  index.actionへリクエスト
  ->indexActionでインスタンス生成
  ->indexActionのexecute実行
  ->"success"が応答されるので struts2の方で自動的に index-success.jsp, index.jspの順にjspファイルを探す
  ->index.jspを表示する

index.jspでボタン押した
  index.jspでhelloメソッドをリクエスト
  ->indexActionでインスタンス生成 !!!!Tips Actionクラスはリクエストのたびに再生成される!!!
  ->indexActionのhelloメソッドを実行
  ->"hello"が応答されるので index-hello.jsp, index.jspの順にjspファイルを探す
  ->index-hello.jspがあるのでindex-hello.jspを表示する

コードビハインド（CodeBehind）
Struts2で追加された新しい機能。この機能によりreturnの値から以下のルールに従って遷移先のページを探してくれる
->xmlファイルにわざわざマッピングする必要がない

1.「/」＋【名前空間】＋「/」＋【Actionクラス名からActionを除いたもの】＋「-」＋【メソッド実行時に返される文字列】＋「.jsp」、または「.vm」、または「.ftl」
2.「/」＋【名前空間】＋「/」＋【Actionクラス名からActionを除いたもの】＋「.jsp」、または「.vm」、または「.ftl」
以下の例だと 1.で /test/index-hello.jsp 2.で/test/index.jsp になる



-  没 eclipseでログの出力される場所
C:\pleiades\workspace\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\logs
C:\pleiades\workspace\.metadata\.plugins\org.eclipse.wst.server.core\tmp2\logs
なぜかaccessログしか出力されない

